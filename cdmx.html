<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0A0A12">
<title>ExpertCell CDMX - Compromiso del D√≠a</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root {
  --fire:#FF4D00; --fire-glow:rgba(255,77,0,0.3);
  --gold:#FFB800; --gold-light:#FFD700;
  --dark:#0A0A12; --dark2:#0E0E18;
  --card:#15151F; --card-border:#252535;
  --blue:#00AAFF; --blue-dark:#101820; --blue-border:#1E3050;
  --coord-bg:#1F1A14; --coord-border:#3D2E1A;
  --green:#00DD77;
  --white:#fff; --w70:#B3B3B3; --w50:#808080;
  --w30:#4D4D4D; --w20:#333; --w10:#1A1A28;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--dark);color:var(--white);font-family:'Outfit',sans-serif;min-height:100vh;min-height:100dvh;overflow-x:hidden}

/* NAV */
.nav{display:flex;background:var(--dark2);border-bottom:1px solid var(--w10);position:sticky;top:0;z-index:100}
.nav-btn{flex:1;padding:14px 4px;background:transparent;border:none;border-bottom:2.5px solid transparent;color:var(--w30);font-family:'Outfit',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:all .3s}
.nav-btn.active{background:var(--card)}
.nav-btn[data-tab="generator"].active{color:var(--fire);border-bottom-color:var(--fire)}
.nav-btn[data-tab="avance"].active{color:var(--green);border-bottom-color:var(--green)}
.nav-btn[data-tab="tracker"].active{color:var(--gold);border-bottom-color:var(--gold)}

.container{max-width:920px;margin:0 auto;padding:24px 16px 40px}
.hidden{display:none!important}
.page-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(26px,6vw,42px);letter-spacing:3px;text-align:center;color:var(--white);margin-bottom:4px}
.page-sub{text-align:center;color:var(--w30);font-size:12px;letter-spacing:1px;margin-bottom:24px}
.section-head{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.section-icon{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.icon-sup{background:var(--fire)}.icon-coord{background:var(--gold)}.icon-cap{background:var(--blue)}
.section-label{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:3px;color:var(--w70);flex-grow:1}
.section-total{font-family:'Bebas Neue',sans-serif;font-size:14px;color:var(--gold);letter-spacing:1px}

.input-grid{display:grid;gap:10px;margin-bottom:22px}
.input-grid.sup{grid-template-columns:repeat(2,1fr)}
.input-grid.wide{grid-template-columns:repeat(2,1fr)}
@media(max-width:400px){.input-grid.sup{grid-template-columns:repeat(2,1fr)}}
.input-card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:14px 10px;text-align:center}
.input-card.coord{background:var(--coord-bg);border-color:var(--coord-border)}
.input-card.cap{background:var(--blue-dark);border-color:var(--blue-border)}
.input-card .name{font-size:10px;font-weight:800;letter-spacing:2px;color:var(--w70);margin-bottom:8px}
.input-card input{width:100%;background:rgba(255,255,255,0.04);border:1px solid var(--card-border);border-radius:10px;color:var(--fire);font-family:'Bebas Neue',sans-serif;font-size:36px;text-align:center;padding:6px 0;outline:none;transition:border-color .3s}
.input-card input:focus{border-color:var(--fire)}
.input-card.coord input{color:var(--gold)}.input-card.coord input:focus{border-color:var(--gold)}
.input-card.cap input{color:var(--blue)}.input-card.cap input:focus{border-color:var(--blue)}

.total-box{background:linear-gradient(135deg,#1A1210,var(--card));border:1px solid #332010;border-radius:16px;padding:20px;text-align:center;margin:8px 0 16px}
.total-box .label{color:var(--w50);font-size:11px;letter-spacing:2px;margin-bottom:4px}
.total-box .number{font-family:'Bebas Neue',sans-serif;font-size:64px;color:var(--fire);line-height:1}
.total-box .unit{font-family:'Bebas Neue',sans-serif;font-size:12px;color:var(--w30);letter-spacing:8px}

.btn-generate{width:100%;padding:16px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--fire),var(--gold));color:var(--dark);font-family:'Outfit',sans-serif;font-size:15px;font-weight:900;letter-spacing:2px;cursor:pointer}
.btn-generate:disabled{background:var(--w10);color:var(--w30);cursor:default;opacity:.5}
.btn-row{display:flex;gap:10px;margin-top:16px}
.btn-secondary{flex:1;padding:14px;border-radius:12px;border:1px solid var(--card-border);background:var(--card);color:var(--w70);font-family:'Outfit',sans-serif;font-size:13px;font-weight:700;cursor:pointer}
.btn-primary{flex:1;padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--fire),var(--gold));color:var(--dark);font-family:'Outfit',sans-serif;font-size:13px;font-weight:900;cursor:pointer}

/* POSTER */
.poster{background:var(--dark);padding:28px 20px 20px;border-radius:20px;border:1px solid var(--w10);position:relative;overflow:hidden}
.poster .glow1{position:absolute;top:-100px;left:-50px;width:300px;height:300px;background:radial-gradient(circle,rgba(255,77,0,0.1)0%,transparent 70%);pointer-events:none}
.poster .glow2{position:absolute;bottom:-80px;right:-50px;width:250px;height:250px;background:radial-gradient(circle,rgba(255,184,0,0.07)0%,transparent 70%);pointer-events:none}
.poster .date-badge{text-align:center;margin-bottom:12px;position:relative}
.poster .date-badge span{display:inline-block;background:linear-gradient(135deg,var(--fire),var(--gold));color:var(--dark);font-weight:800;font-size:8px;padding:5px 20px;border-radius:20px;letter-spacing:1.5px}
.poster .poster-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(32px,7vw,48px);letter-spacing:3px;text-align:center;color:var(--white);line-height:1;margin-bottom:4px;position:relative}
.poster .poster-sub{text-align:center;font-size:11px;color:var(--w30);letter-spacing:2px;margin-bottom:18px}
.poster .poster-sub b{color:var(--gold)}
.poster .big-num{text-align:center;margin-bottom:8px;position:relative}
.poster .big-num .n{font-family:'Bebas Neue',sans-serif;font-size:clamp(72px,18vw,100px);color:var(--fire);line-height:1}
.poster .big-num .u{font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:10px;color:var(--w30);margin-top:-2px}
.poster .big-num .s{font-size:9px;color:var(--w20);letter-spacing:1px;margin-top:4px}
.poster .divider{text-align:center;margin:12px 0;font-size:14px;color:var(--fire)}
.poster .divider .dl{display:inline-block;width:40px;height:1px;background:var(--fire);vertical-align:middle;opacity:.5}
.poster .p-cards{display:grid;gap:8px;margin-bottom:4px}
.poster .p-cards.p-sup{grid-template-columns:repeat(4,1fr)}
.poster .p-cards.p-wide{grid-template-columns:repeat(2,1fr)}
@media(max-width:500px){.poster .p-cards.p-sup{grid-template-columns:repeat(2,1fr)}}
.poster .p-card{border-radius:12px;padding:12px 4px 10px;text-align:center;position:relative;border:1px solid}
.poster .p-card .accent{position:absolute;top:0;left:15%;right:15%;height:2.5px;border-radius:0 0 3px 3px}
.poster .p-card .pname{font-size:8px;font-weight:800;letter-spacing:2px;color:var(--w70)}
.poster .p-card .pnum{font-family:'Bebas Neue',sans-serif;font-size:32px;line-height:1.1}
.poster .p-card .plabel{font-size:7px;color:var(--w20);letter-spacing:2px}
.poster .p-card.ps{background:var(--card);border-color:var(--card-border)}.poster .p-card.ps .accent{background:var(--fire)}.poster .p-card.ps .pnum{color:var(--fire)}
.poster .p-card.pc{background:var(--coord-bg);border-color:var(--coord-border)}.poster .p-card.pc .accent{background:var(--gold)}.poster .p-card.pc .pnum{color:var(--gold);font-size:38px}
.poster .p-card.pp{background:var(--blue-dark);border-color:var(--blue-border)}.poster .p-card.pp .accent{background:var(--blue)}.poster .p-card.pp .pnum{color:var(--blue);font-size:38px}
.poster .pbar-wrap{margin:14px 0 10px}
.poster .pbar-labels{display:flex;justify-content:space-between;font-size:7px;color:var(--w20);letter-spacing:1.5px;margin-bottom:4px}
.poster .pbar{width:100%;height:6px;background:var(--w10);border-radius:4px;overflow:hidden}
.poster .pbar-fill{width:100%;height:100%;background:linear-gradient(90deg,var(--fire),var(--gold));border-radius:4px}
.poster .mot-box{background:#18120E;border:1px solid #33200E;border-radius:14px;padding:18px 16px 14px;text-align:center;margin-top:10px}
.poster .mot-box .mq{font-family:'Bebas Neue',sans-serif;font-size:clamp(15px,3.5vw,20px);letter-spacing:1.5px;line-height:1.35;color:var(--white)}
.poster .mot-box .mq .gold{color:var(--gold)}
.poster .mot-box .ms{font-size:8px;color:var(--w30);margin-top:8px;letter-spacing:1px}
.poster .footer-text{text-align:center;margin-top:12px;font-size:7px;color:var(--w20);letter-spacing:2px}

/* AVANCE */
.corte-selector{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:20px}

/* AVANCE POSTER (compact for sharing) */
.av-poster{position:absolute;left:-9999px;top:0;width:420px;background:#0A0A12;padding:24px 20px 18px;font-family:'Outfit',sans-serif;color:#fff}
.av-poster .avp-badge{text-align:center;margin-bottom:10px}
.av-poster .avp-badge span{display:inline-block;background:linear-gradient(135deg,#00DD77,#00AAFF);color:#0A0A12;font-weight:800;font-size:7px;padding:4px 16px;border-radius:16px;letter-spacing:1.5px}
.av-poster .avp-title{font-family:'Bebas Neue',sans-serif;font-size:32px;text-align:center;letter-spacing:3px;line-height:1;margin-bottom:2px}
.av-poster .avp-sub{text-align:center;font-size:10px;color:#666;letter-spacing:1px;margin-bottom:14px}
.av-poster .avp-sub b{color:#00DD77}
.av-poster .avp-summary{display:flex;gap:8px;margin-bottom:14px}
.av-poster .avp-scard{flex:1;background:#15151F;border:1px solid #252535;border-radius:12px;padding:10px 6px;text-align:center}
.av-poster .avp-scard .avp-sl{font-size:7px;color:#4D4D4D;letter-spacing:1.5px;margin-bottom:3px}
.av-poster .avp-scard .avp-sn{font-family:'Bebas Neue',sans-serif;font-size:32px;line-height:1}
.av-poster .avp-bar-wrap{height:8px;background:#1A1A28;border-radius:4px;overflow:hidden;margin-bottom:14px}
.av-poster .avp-bar-fill{height:100%;border-radius:4px;transition:width .3s}
.av-poster .avp-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid #12121C}
.av-poster .avp-row:last-child{border-bottom:none}
.av-poster .avp-rname{font-size:11px;font-weight:700;min-width:65px}
.av-poster .avp-rbar{flex-grow:1;height:6px;background:#1A1A28;border-radius:3px;overflow:hidden}
.av-poster .avp-rbar-fill{height:100%;border-radius:3px}
.av-poster .avp-rnums{font-size:10px;min-width:55px;text-align:right;color:#808080}
.av-poster .avp-rnums b{color:#fff}
.av-poster .avp-rpct{font-family:'Bebas Neue',sans-serif;font-size:14px;min-width:36px;text-align:right}
.av-poster .avp-footer{text-align:center;margin-top:12px;font-size:7px;color:#333;letter-spacing:2px}
.corte-btn{padding:6px 12px;border-radius:10px;border:1px solid var(--card-border);background:var(--card);color:var(--w50);font-family:'Outfit',sans-serif;font-size:10px;font-weight:700;cursor:pointer;transition:all .2s;letter-spacing:.5px;text-align:center}
.corte-btn.active{background:var(--green);color:var(--dark);border-color:var(--green)}
.corte-btn .cc{display:block;font-family:'Bebas Neue',sans-serif;font-size:16px;margin-top:1px}
.avance-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.av-card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:14px 10px;text-align:center;position:relative;overflow:hidden}
.av-card .av-label{font-size:8px;color:var(--w30);letter-spacing:2px;margin-bottom:4px}
.av-card .av-num{font-family:'Bebas Neue',sans-serif;font-size:36px;line-height:1}
.av-card .av-bar{position:absolute;bottom:0;left:0;height:3px;border-radius:0 3px 0 0;transition:width .5s}
.avance-member{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:14px;margin-bottom:10px}
.av-mem-top{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.av-mem-name{font-weight:700;font-size:13px;flex-grow:1}
.av-mem-badge{font-family:'Bebas Neue',sans-serif;font-size:11px;padding:3px 10px;border-radius:8px;letter-spacing:1px}
.av-mem-progress{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.av-mem-bar-wrap{flex-grow:1;height:8px;background:var(--w10);border-radius:4px;overflow:hidden}
.av-mem-bar{height:100%;border-radius:4px;transition:width .5s}
.av-mem-pct{font-family:'Bebas Neue',sans-serif;font-size:16px;min-width:42px;text-align:right}
.av-mem-nums{display:flex;justify-content:space-between;font-size:10px;color:var(--w30)}
.av-input-row{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:10px;border-top:1px solid var(--w10)}
.av-input{flex-grow:1;background:rgba(255,255,255,0.04);border:1px solid var(--card-border);border-radius:10px;color:var(--white);font-family:'Outfit',sans-serif;font-size:14px;padding:10px 14px;outline:none}
.av-input:focus{border-color:var(--green)}
.av-input::placeholder{color:var(--w20)}
.av-save-btn{background:var(--green);color:var(--dark);border:none;border-radius:10px;padding:10px 16px;font-family:'Outfit',sans-serif;font-size:13px;font-weight:800;cursor:pointer}
.hour-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #12121C}
.hour-label{font-family:'Bebas Neue',sans-serif;font-size:14px;color:var(--w30);min-width:50px;letter-spacing:1px}
.hour-label.hl-active{color:var(--green)}
.hour-dots{display:flex;gap:4px;flex-wrap:wrap;flex-grow:1}
.hour-dot{width:8px;height:8px;border-radius:50%}

/* TRACKER */
.week-nav{display:flex;align-items:center;justify-content:center;gap:16px;margin-bottom:20px}
.week-nav button{background:var(--card);border:1px solid var(--card-border);border-radius:10px;color:var(--w70);padding:8px 14px;font-size:16px;cursor:pointer}
.week-nav .wk-title{text-align:center}
.week-nav .wk-title h2{font-family:'Bebas Neue',sans-serif;color:var(--white);font-size:20px;letter-spacing:2px}
.week-nav .wk-title p{color:var(--w30);font-size:11px}
.summary-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}
.summary-card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:14px;text-align:center}
.summary-card .sc-label{font-size:9px;color:var(--w30);letter-spacing:2px;margin-bottom:4px}
.summary-card .sc-num{font-family:'Bebas Neue',sans-serif;font-size:34px;line-height:1}
.table-wrap{overflow-x:auto;border-radius:16px;border:1px solid var(--w10);-webkit-overflow-scrolling:touch}
.table-wrap table{width:100%;border-collapse:collapse;min-width:620px}
.table-wrap th,.table-wrap td{border-bottom:1px solid #12121C}
.table-wrap thead th{padding:12px 6px;text-align:center;background:var(--dark2);font-size:10px;font-weight:800;color:var(--w30)}
.table-wrap thead th:first-child{text-align:left;padding-left:12px;position:sticky;left:0;background:var(--dark2);z-index:2;min-width:90px}
.table-wrap thead th.today{background:#1A1510;color:var(--gold)}
.table-wrap .group-row td{padding:8px 10px;background:var(--dark)}
.table-wrap .member-row td{padding:8px 4px;text-align:center;vertical-align:middle}
.table-wrap .member-row td:first-child{text-align:left;padding-left:12px;color:#ccc;font-size:12px;font-weight:600;position:sticky;left:0;background:var(--dark);z-index:1}
.table-wrap .member-row td.today-col{background:rgba(255,184,0,0.03)}
.check-btn{width:32px;height:32px;border-radius:8px;border:2px solid var(--w20);background:rgba(255,255,255,0.02);color:transparent;font-size:16px;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center}
.check-btn.checked{border-color:var(--green);background:rgba(0,221,119,0.1);color:var(--green)}
.commit-val{color:var(--w30);font-size:9px;margin-bottom:3px}
.mini-input{width:38px;padding:6px 2px;text-align:center;background:rgba(255,255,255,0.03);border:1px solid var(--w10);border-radius:8px;color:var(--w30);font-size:12px;font-family:'Outfit',sans-serif;outline:none}
.mini-input:focus{border-color:var(--fire);color:var(--fire)}
.pct-cell .pct-num{font-family:'Bebas Neue',sans-serif;font-size:18px}
.pct-cell .pct-detail{color:var(--w20);font-size:8px}
.legend{display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:16px}
.legend-item{display:flex;align-items:center;gap:5px;color:var(--w30);font-size:11px}
.app-footer{text-align:center;margin-top:20px;font-size:8px;color:var(--w20);letter-spacing:2px}

.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--green);color:var(--dark);padding:12px 24px;border-radius:12px;font-weight:700;font-size:13px;letter-spacing:1px;z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1}
</style>
</head>
<body>

<nav class="nav">
  <button class="nav-btn active" data-tab="generator" onclick="showTab('generator')">üî• COMPROMISO</button>
  <button class="nav-btn" data-tab="avance" onclick="showTab('avance')">üìà AVANCE</button>
  <button class="nav-btn" data-tab="tracker" onclick="showTab('tracker')">üìä TRACKER</button>
</nav>
<div style="text-align:center;padding:6px;background:var(--dark2);border-bottom:1px solid var(--w10)">
  <span id="sync-status" style="font-size:10px;color:var(--w30);letter-spacing:1px">‚è≥ Cargando...</span>
  <button onclick="syncAll()" style="background:none;border:none;color:var(--blue);font-size:10px;cursor:pointer;margin-left:8px;font-family:'Outfit',sans-serif">üîÑ Sync</button>
</div>

<!-- TAB 1: GENERATOR -->
<div id="tab-generator" class="container">
  <div id="input-view">
    <h1 class="page-title">CAPTURA EL COMPROMISO</h1>
    <p class="page-sub" id="date-display"></p>
    <div class="section-head"><div class="section-icon icon-sup">‚ö°</div><span class="section-label">SUPERVISORES</span><span class="section-total" id="total-sup">0 ventas</span></div>
    <div class="input-grid sup" id="grid-sup"></div>
    <div class="section-head"><div class="section-icon icon-coord">üëë</div><span class="section-label">COORDINADORES</span><span class="section-total" id="total-coord">0 ventas</span></div>
    <div class="input-grid wide" id="grid-coord"></div>
    <div class="section-head"><div class="section-icon icon-cap">üìò</div><span class="section-label">CAPACITADORES</span><span class="section-total" id="total-cap">0 ventas</span></div>
    <div class="input-grid wide" id="grid-cap"></div>
    <div class="total-box"><div class="label">TOTAL COMPROMETIDO</div><div class="number" id="grand-total">0</div><div class="unit">VENTAS</div></div>
    <button class="btn-generate" id="btn-gen" disabled onclick="generate()">üî• GENERAR COMPROMISO DEL D√çA</button>
  </div>
  <div id="poster-view" class="hidden">
    <div class="poster" id="poster-content">
      <div class="glow1"></div><div class="glow2"></div>
      <div class="date-badge"><span id="poster-date"></span></div>
      <div class="poster-title">COMPROMISO DEL D√çA</div>
      <div class="poster-sub">Palabra dada. <b>Resultado asegurado.</b></div>
      <div class="big-num"><div class="n" id="poster-total">0</div><div class="u">VENTAS</div><div class="s">Meta comprometida por el equipo ExpertCell</div></div>
      <div class="divider"><span class="dl"></span> üî• <span class="dl"></span></div>
      <div id="poster-sections"></div>
      <div class="pbar-wrap"><div class="pbar-labels"><span>0 VENTAS</span><span id="poster-bar-label">META: 0</span></div><div class="pbar"><div class="pbar-fill"></div></div></div>
      <div class="mot-box"><div class="mq">"HOY NO SE TRATA DE PODER.<br>SE TRATA DE QUERER.<br><span class="gold">Y USTEDES YA DIJERON: ¬°YO QUIERO!"</span></div><div class="ms">Cada venta cuenta. Cada uno de ustedes cuenta. üí™</div></div>
      <div class="footer-text">EXPERTCELL CDMX ‚Äî EQUIPO AT&T ¬∑ PALABRA DE CAMPEONES</div>
    </div>
    <div class="btn-row">
      <button class="btn-secondary" onclick="backToEdit()">‚Üê EDITAR</button>
      <button class="btn-primary" onclick="screenshot('poster-content','Compromiso')">üì± DESCARGAR IMAGEN</button>
    </div>
  </div>
</div>

<!-- TAB 2: AVANCE -->
<div id="tab-avance" class="container hidden">
  <div style="text-align:center;margin-bottom:20px">
    <h1 class="page-title">AVANCE DEL D√çA</h1>
    <p class="page-sub" id="avance-date"></p>
    <div style="display:inline-block;background:var(--card);border:1px solid var(--card-border);border-radius:12px;padding:8px 20px">
      <div id="live-clock" style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--green);letter-spacing:2px">--:--</div>
    </div>
  </div>
  <div class="corte-selector" id="corte-selector"></div>
  <div id="avance-share-area">
  <div class="avance-summary" style="grid-template-columns:repeat(4,1fr)">
    <div class="av-card"><div class="av-label">META</div><div class="av-num" id="av-committed" style="color:var(--fire)">0</div></div>
    <div class="av-card" style="position:relative"><div class="av-label">HECHAS</div><div class="av-num" id="av-done" style="color:var(--green)">0</div><div class="av-bar" id="av-bar-done" style="background:var(--green);width:0%"></div></div>
    <div class="av-card"><div class="av-label">FALTAN</div><div class="av-num" id="av-remaining" style="color:var(--gold)">0</div></div>
    <div class="av-card" style="position:relative"><div class="av-label">PROYECCI√ìN</div><div class="av-num" id="av-projection" style="color:var(--blue)">-</div><div class="av-bar" id="av-bar-proj" style="background:var(--blue);width:0%"></div></div>
  </div>
  <div id="avance-members"></div>
  <div id="hour-timeline" style="margin-top:20px"></div>
  <div class="app-footer" style="margin-top:24px">EXPERTCELL CDMX ‚Äî AVANCE AT&T</div>
  </div>
  <div style="margin-top:16px">
    <button class="btn-primary" style="width:100%" onclick="shareAvance()">üì± DESCARGAR IMAGEN DEL AVANCE</button>
  </div>
</div>

<!-- TAB 3: TRACKER -->
<div id="tab-tracker" class="container hidden">
  <div class="week-nav">
    <button onclick="navWeek(-1)">‚óÄ</button>
    <div class="wk-title"><h2>SEMANA</h2><p id="week-range"></p></div>
    <button onclick="navWeek(1)">‚ñ∂</button>
  </div>
  <div id="tracker-share-area">
  <div class="summary-row">
    <div class="summary-card"><div class="sc-label">COMPROMISOS</div><div class="sc-num" id="wk-total" style="color:var(--fire)">0</div></div>
    <div class="summary-card"><div class="sc-label">CUMPLIDOS</div><div class="sc-num" id="wk-met" style="color:var(--green)">0</div></div>
    <div class="summary-card"><div class="sc-label">% CUMPLIMIENTO</div><div class="sc-num" id="wk-pct">0%</div></div>
  </div>
  <div class="table-wrap"><table id="tracker-table"></table></div>
  <div class="app-footer" style="margin-top:12px">EXPERTCELL CDMX ‚Äî TRACKER AT&T</div>
  </div>
  <div style="margin-top:16px">
    <button class="btn-primary" style="width:100%;background:linear-gradient(135deg,var(--gold),var(--fire))" onclick="shareTracker()">üì± DESCARGAR IMAGEN DEL TRACKER</button>
  </div>
  <div class="legend">
    <div class="legend-item"><div style="width:18px;height:18px;border-radius:5px;border:2px solid var(--green);background:rgba(0,221,119,0.1);color:var(--green);display:inline-flex;align-items:center;justify-content:center;font-size:11px">‚úì</div><span>Cumpli√≥</span></div>
    <div class="legend-item"><div style="width:18px;height:18px;border-radius:5px;border:2px solid var(--w20)"></div><span>No cumpli√≥</span></div>
    <div class="legend-item"><span style="color:var(--green);font-weight:900">80%+</span><span>Excelente</span></div>
    <div class="legend-item"><span style="color:var(--gold);font-weight:900">50%+</span><span>Regular</span></div>
    <div class="legend-item"><span style="color:var(--fire);font-weight:900">&lt;50%</span><span>Bajo</span></div>
  </div>
  <div class="app-footer">EXPERTCELL CDMX ‚Äî TRACKER AT&T</div>
</div>

<div class="toast" id="toast"></div>
<!-- Hidden compact avance poster for screenshot -->
<div class="av-poster" id="avance-poster"></div>
<!-- Hidden compact tracker poster for screenshot -->
<div class="av-poster" id="tracker-poster"></div>

<script>
const TEAM={supervisores:["Mar√≠a Fernanda","Angelica","Itzel","Site Neza"],coordinadores:["Marco Olguin"],capacitadores:["Capacitaci√≥n"]};
const GM={supervisores:{icon:"‚ö°",cls:"ps",ic:"",clr:"var(--fire)"},coordinadores:{icon:"üëë",cls:"pc",ic:"coord",clr:"var(--gold)"},capacitadores:{icon:"üìò",cls:"pp",ic:"cap",clr:"var(--blue)"}};
const ALL=[];Object.keys(TEAM).forEach(g=>TEAM[g].forEach(n=>ALL.push({name:n,group:g})));
const DAYS_ES=["DOMINGO","LUNES","MARTES","MI√âRCOLES","JUEVES","VIERNES","S√ÅBADO"];
const MO_ES=["","ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
const DS=["DOM","LUN","MAR","MI√â","JUE","VIE","S√ÅB"];
const CORTES=["11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00+"];
const commits={};ALL.forEach(m=>commits[m.name]=0);
let weekStart=getMonday(new Date()),selCorte=null;

function load(k){try{return JSON.parse(localStorage.getItem(k)||"{}")}catch{return{}}}
async function save(k,d){try{localStorage.setItem(k,JSON.stringify(d))}catch{};await cloudSave(k,d)}

// ‚ïê‚ïê‚ïê CLOUD SYNC (Google Sheets via iframe POST + fetch GET) ‚ïê‚ïê‚ïê
const API_URL="https://script.google.com/macros/s/AKfycbwKuJkwFp3OlnxBqbLrajxqMM225yJhmuhVmTFgJQPfp19tE8ToeEGhJiDpFA3p0Rh5/exec";

let saving=false;

async function cloudSave(key,data){
  if(!API_URL)return;
  if(saving){
    // Queue for after current save finishes
    setTimeout(()=>cloudSave(key,data),500);
    return;
  }
  saving=true;
  updateSyncBadge("loading");
  try{
    const payload=encodeURIComponent(JSON.stringify(data));
    const url=`${API_URL}?action=write&key=${encodeURIComponent(key)}&data=${payload}&t=${Date.now()}`;
    const resp=await fetch(url,{redirect:"follow"});
    const text=await resp.text();
    try{
      const json=JSON.parse(text);
      if(json.success){
        // Update local with server merged data
        if(json.data)try{localStorage.setItem(key,json.data)}catch{}
        updateSyncBadge("ok");
      }else{
        console.log("Write fail:",json.error);updateSyncBadge("error");
      }
    }catch{console.log("Parse fail:",text.substring(0,200));updateSyncBadge("error")}
  }catch(e){console.log("Save err:",e);updateSyncBadge("error")}
  saving=false;
}

async function cloudLoad(key){
  if(!API_URL)return null;
  try{
    // Use Google Apps Script content service ‚Äî fetch with redirect follow
    const url=`${API_URL}?action=read&key=${encodeURIComponent(key)}&t=${Date.now()}`;
    const resp=await fetch(url,{redirect:"follow"});
    const text=await resp.text();
    // Apps Script sometimes wraps in HTML after redirect, try to extract JSON
    let json;
    try{json=JSON.parse(text)}catch{
      // Try extracting JSON from possible HTML wrapper
      const match=text.match(/\{[\s\S]*\}/);
      if(match)json=JSON.parse(match[0]);
      else{console.log("Cannot parse:",text.substring(0,200));return null}
    }
    if(json.success&&json.data){
      let parsed;
      try{parsed=JSON.parse(json.data)}catch{return null}
      if(Object.keys(parsed).length===0)return null;
      // Merge: cloud wins
      const local=load(key);const merged={...local};
      for(const dk in parsed){
        if(!merged[dk])merged[dk]=parsed[dk];
        else for(const mk in parsed[dk]){
          const inc=parsed[dk][mk];
          if(!merged[dk][mk])merged[dk][mk]=inc;
          else{
            merged[dk][mk]={...merged[dk][mk],...inc};
            if(inc.cortes)merged[dk][mk].cortes={...(merged[dk][mk].cortes||{}),...inc.cortes};
          }
        }
      }
      try{localStorage.setItem(key,JSON.stringify(merged))}catch{}
      return merged;
    }
  }catch(e){console.log("Load err:",e)}
  return null;
}

function updateSyncBadge(s){
  const el=document.getElementById("sync-status");if(!el)return;
  const map={ok:["‚òÅÔ∏è Sincronizado","var(--green)"],loading:["üîÑ Sincronizando...","var(--blue)"],error:["‚ùå Error sync","var(--fire)"],offline:["üì± Solo local","var(--gold)"]};
  const v=map[s]||map.offline;el.textContent=v[0];el.style.color=v[1];
}

async function syncAll(){
  if(!API_URL){updateSyncBadge("offline");loadTodayCommit();return}
  updateSyncBadge("loading");
  try{
    await cloudLoad("ec-cdmx-tracker");await cloudLoad("ec-cdmx-avance");
    updateSyncBadge("ok");
    loadTodayCommit();
    const ab=document.querySelector(".nav-btn.active");
    if(ab){const t=ab.dataset.tab;if(t==="tracker")renderTracker();if(t==="avance")renderAvance()}
  }catch(e){console.log("syncAll err:",e);updateSyncBadge("error");loadTodayCommit()}
}

// Auto-load today's commitment from stored data
function loadTodayCommit(){
  const dk=toKey(new Date()),tr=load("ec-cdmx-tracker");
  if(!tr[dk])return;
  let loaded=false;
  ALL.forEach(m=>{
    if(tr[dk][m.name]&&tr[dk][m.name].committed>0){
      commits[m.name]=tr[dk][m.name].committed;
      const inp=document.getElementById("inp-"+m.name.replace(/[^a-zA-Z]/g,""));
      if(inp)inp.value=commits[m.name];
      loaded=true;
    }
  });
  if(loaded)updTotals();
}
function toKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`}
function getMonday(d){const t=new Date(d),dy=t.getDay();t.setDate(t.getDate()-dy+(dy===0?-6:1));t.setHours(0,0,0,0);return t}
function weekDays(s){return Array.from({length:6},(_,i)=>{const d=new Date(s);d.setDate(s.getDate()+i);return d})}
function fmtDate(d){return`${DAYS_ES[d.getDay()]} ${d.getDate()} DE ${MO_ES[d.getMonth()+1]} DE ${d.getFullYear()}`}
function pctClr(p){return p>=80?"var(--green)":p>=50?"var(--gold)":"var(--fire)"}
function gClr(g){return GM[g].clr}
function showToast(m){const t=document.getElementById("toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2500)}

// Projection: rate per hour √ó total hours (9: 10am-7pm)
function calcProjection(dd,totalDone){
  // Find last corte with any data
  const TOTAL_HOURS=9; // 10am to 7pm
  const corteHours={"11:00":1,"12:00":2,"13:00":3,"14:00":4,"15:00":5,"16:00":6,"17:00":7,"18:00":8,"19:00+":9};
  let lastCorte=null;
  const coordSet=new Set(TEAM.coordinadores);
  for(let i=CORTES.length-1;i>=0;i--){
    const c=CORTES[i];
    let hasData=false;
    ALL.forEach(m=>{const d=dd[m.name];if(d&&!coordSet.has(m.name)&&d.cortes&&d.cortes[c])hasData=true});
    if(hasData){lastCorte=c;break}
  }
  if(!lastCorte||!corteHours[lastCorte])return null;
  const hoursElapsed=corteHours[lastCorte];
  if(hoursElapsed<=0||totalDone<=0)return null;
  const rate=totalDone/hoursElapsed;
  return Math.round(rate*TOTAL_HOURS);
}

function showTab(tab){
  ["generator","avance","tracker"].forEach(t=>document.getElementById("tab-"+t).classList.toggle("hidden",t!==tab));
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.toggle("active",b.dataset.tab===tab));
  if(tab==="tracker")renderTracker();if(tab==="avance")renderAvance();
}

// ‚ïê‚ïê‚ïê TAB 1 ‚ïê‚ïê‚ïê
function buildInputs(){
  document.getElementById("date-display").textContent=`Ingresa las ventas comprometidas para hoy ‚Äî ${fmtDate(new Date())}`;
  ["supervisores","coordinadores","capacitadores"].forEach(g=>{
    const gid=g==="supervisores"?"grid-sup":g==="coordinadores"?"grid-coord":"grid-cap";
    const el=document.getElementById(gid);el.innerHTML="";
    TEAM[g].forEach(n=>{const c=document.createElement("div");c.className=`input-card ${GM[g].ic}`;c.innerHTML=`<div class="name">${n.toUpperCase()}</div><input type="text" inputmode="numeric" placeholder="0" oninput="onCI('${n}',this.value)" id="inp-${n.replace(/[^a-zA-Z]/g,"")}">`;el.appendChild(c)});
  });
}
function onCI(n,v){commits[n]=parseInt(v.replace(/\D/g,""))||0;updTotals()}
function updTotals(){
  let gt=0;["supervisores","coordinadores","capacitadores"].forEach(g=>{let s=0;TEAM[g].forEach(n=>s+=commits[n]);document.getElementById(g==="supervisores"?"total-sup":g==="coordinadores"?"total-coord":"total-cap").textContent=s+" ventas";if(g!=="coordinadores")gt+=s});
  document.getElementById("grand-total").textContent=gt;document.getElementById("btn-gen").disabled=gt===0;
}
async function generate(){
  const now=new Date(),gt=+document.getElementById("grand-total").textContent;
  document.getElementById("poster-date").textContent=fmtDate(now);
  document.getElementById("poster-total").textContent=gt;
  document.getElementById("poster-bar-label").textContent=`META: ${gt} VENTAS`;
  const ct=document.getElementById("poster-sections");ct.innerHTML="";
  ["supervisores","coordinadores","capacitadores"].forEach(g=>{
    const ms=TEAM[g].filter(n=>commits[n]>0);if(!ms.length)return;
    const gm=GM[g],sm=ms.reduce((s,n)=>s+commits[n],0),ic=g==="supervisores"?"icon-sup":g==="coordinadores"?"icon-coord":"icon-cap",cg=g==="supervisores"?"p-sup":"p-wide";
    let h=`<div style="margin-bottom:14px"><div class="section-head"><div class="section-icon ${ic}">${gm.icon}</div><span class="section-label">${g.toUpperCase()}</span><span class="section-total">${sm} ventas</span></div><div class="p-cards ${cg}">`;
    ms.forEach(n=>{h+=`<div class="p-card ${gm.cls}"><div class="accent"></div><div class="pname">${n.toUpperCase()}</div><div class="pnum">${commits[n]}</div><div class="plabel">VENTAS</div></div>`});
    h+=`</div></div>`;ct.innerHTML+=h;
  });
  const dk=toKey(now),tr=load("ec-cdmx-tracker"),av=load("ec-cdmx-avance");
  if(!tr[dk])tr[dk]={};if(!av[dk])av[dk]={};
  ALL.forEach(m=>{if(commits[m.name]>0){tr[dk][m.name]={committed:commits[m.name],met:tr[dk]?.[m.name]?.met||false};if(!av[dk][m.name])av[dk][m.name]={committed:commits[m.name],cortes:{}}}});
  await save("ec-cdmx-tracker",tr);await save("ec-cdmx-avance",av);
  document.getElementById("input-view").classList.add("hidden");document.getElementById("poster-view").classList.remove("hidden");
  showToast("‚úÖ Compromiso guardado");
}
function backToEdit(){document.getElementById("poster-view").classList.add("hidden");document.getElementById("input-view").classList.remove("hidden")}

// ‚ïê‚ïê‚ïê TAB 2: AVANCE ‚ïê‚ïê‚ïê
function renderAvance(){
  const now=new Date(),dk=toKey(now);
  document.getElementById("avance-date").textContent=fmtDate(now);updClock();
  const av=load("ec-cdmx-avance"),dd=av[dk]||{};
  const ch=now.getHours();
  if(!selCorte){if(ch<11)selCorte="11:00";else if(ch>=19)selCorte="19:00+";else{selCorte=ch+":00";if(!CORTES.includes(selCorte))selCorte=CORTES[0]}}

  // Corte buttons ‚Äî ACUMULADO logic helpers
  const coordNames=new Set(TEAM.coordinadores);
  // Total done = highest acumulado reported across all cortes
  function getMemberDone(md){
    if(!md||!md.cortes)return 0;
    let max=0;
    CORTES.forEach(c=>{const v=md.cortes[c];if(v!==undefined&&v!==null&&v!==""&&v>max)max=v});
    return max;
  }
  // New sales in a specific corte = acumulado[corte] - acumulado[previous corte]
  function getCorteNew(md,corte){
    if(!md||!md.cortes||!md.cortes[corte])return 0;
    const idx=CORTES.indexOf(corte);
    let prev=0;
    for(let i=idx-1;i>=0;i--){if(md.cortes[CORTES[i]]!==undefined&&md.cortes[CORTES[i]]!==null){prev=md.cortes[CORTES[i]];break}}
    return Math.max(0,md.cortes[corte]-prev);
  }
  // Count new sales in a corte excluding coordinadores
  function corteCount(c){let cnt=0;ALL.forEach(m=>{const d=dd[m.name];if(d&&!coordNames.has(m.name))cnt+=getCorteNew(d,c)});return cnt}
  const sel=document.getElementById("corte-selector");sel.innerHTML="";
  CORTES.forEach(c=>{const cnt=corteCount(c);
    const b=document.createElement("button");b.className=`corte-btn ${c===selCorte?"active":""}`;b.onclick=()=>{selCorte=c;renderAvance()};b.innerHTML=`${c}<span class="cc">${cnt}</span>`;sel.appendChild(b)});

  // Totals
  let tCom=0,tDone=0;
  ALL.forEach(m=>{const d=dd[m.name];if(d&&m.group!=="coordinadores"){tCom+=d.committed||0;tDone+=getMemberDone(d)}});
  document.getElementById("av-committed").textContent=tCom;document.getElementById("av-done").textContent=tDone;document.getElementById("av-remaining").textContent=Math.max(0,tCom-tDone);
  document.getElementById("av-bar-done").style.width=(tCom>0?Math.min(100,Math.round(tDone/tCom*100)):0)+"%";

  // Projection: find last corte with data, calc rate, project to end (9 hrs: 10am-7pm)
  const proj=calcProjection(dd,tDone);
  const projEl=document.getElementById("av-projection");
  const projBar=document.getElementById("av-bar-proj");
  if(proj!==null){
    projEl.textContent=proj;
    projEl.style.color=proj>=tCom?"var(--green)":proj>=tCom*0.7?"var(--gold)":"var(--fire)";
    projBar.style.width=(tCom>0?Math.min(100,Math.round(proj/tCom*100)):0)+"%";
    projBar.style.background=proj>=tCom?"var(--green)":proj>=tCom*0.7?"var(--gold)":"var(--fire)";
  }else{projEl.textContent="-";projBar.style.width="0%"}

  // Members
  const mel=document.getElementById("avance-members");mel.innerHTML="";
  let hasData=false;
  ["supervisores","coordinadores","capacitadores"].forEach(g=>{
    const active=TEAM[g].filter(n=>dd[n]);if(!active.length)return;hasData=true;
    const gm=GM[g],ic=g==="supervisores"?"icon-sup":g==="coordinadores"?"icon-coord":"icon-cap";
    mel.innerHTML+=`<div class="section-head" style="margin-top:16px;margin-bottom:8px"><div class="section-icon ${ic}" style="width:24px;height:24px;font-size:12px">${gm.icon}</div><span class="section-label" style="font-size:14px">${g.toUpperCase()}</span></div>`;
    active.forEach(name=>{
      const md=dd[name],com=md.committed||0;let done=getMemberDone(md);
      const left=Math.max(0,com-done),pct=com>0?Math.min(100,Math.round(done/com*100)):0;
      const cv=md.cortes?.[selCorte];
      const hasCorteVal=cv!==undefined&&cv!==null&&cv!=="";
      // Show last known acumulado as reference
      const lastAcum=getMemberDone(md);
      const clr=gClr(g);
      const sc=pct>=100?"var(--green)":pct>=50?"var(--gold)":"var(--fire)";
      const st=pct>=100?"‚úÖ CUMPLIDO":pct>=75?"üî• CASI":pct>=50?"‚ö° MITAD":`‚è≥ FALTAN ${left}`;
      const card=document.createElement("div");card.className="avance-member";
      card.innerHTML=`<div style="display:flex;align-items:center;gap:10px">
          <div style="flex-grow:1">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><div class="av-mem-name" style="color:${clr}">${name}</div><div class="av-mem-badge" style="background:${sc}20;color:${sc}">${st}</div></div>
            <div class="av-mem-progress"><div class="av-mem-bar-wrap"><div class="av-mem-bar" style="width:${pct}%;background:${pct>=100?"var(--green)":clr}"></div></div><div class="av-mem-pct" style="color:${sc}">${pct}%</div></div>
            <div class="av-mem-nums" style="margin-top:4px"><span>Meta: <b style="color:var(--white)">${com}</b></span><span>Hechas: <b style="color:var(--green)">${done}</b></span><span>Faltan: <b style="color:${left>0?"var(--gold)":"var(--green)"}">${left}</b></span></div>
          </div>
          <div style="text-align:center;min-width:60px">
            <div style="font-size:8px;color:var(--w30);margin-bottom:4px">ACUM ${selCorte}</div>
            <input class="av-input" type="text" inputmode="numeric" placeholder="${lastAcum}" value="${hasCorteVal?cv:""}" id="avi-${name.replace(/[^a-zA-Z]/g,"")}" style="width:56px;padding:8px 4px;font-size:18px;font-weight:700;border-radius:10px">
          </div>
        </div>`;
      mel.appendChild(card);
    });
  });
  // Global save button
  if(hasData){
    mel.innerHTML+=`<button class="av-save-btn" onclick="saveAllCortes('${dk}')" style="width:100%;padding:14px;border-radius:14px;margin-top:14px;font-size:15px;letter-spacing:1px">üíæ GUARDAR ACUMULADO ${selCorte}</button>`;
  }
  if(!hasData)mel.innerHTML=`<div style="text-align:center;padding:40px 20px;color:var(--w30)"><div style="font-size:40px;margin-bottom:12px">üìã</div><div style="font-size:14px;font-weight:700;margin-bottom:6px">No hay compromiso para hoy</div><div style="font-size:12px">Ve a üî• COMPROMISO y genera el compromiso del d√≠a primero.</div></div>`;

  // Timeline
  const tl=document.getElementById("hour-timeline");tl.innerHTML=`<div style="font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--w50);letter-spacing:2px;margin-bottom:10px">L√çNEA DE TIEMPO</div>`;
  CORTES.forEach(c=>{const cnt=corteCount(c);
    const isA=c===selCorte;let dots="";for(let i=0;i<Math.min(cnt,40);i++)dots+=`<div class="hour-dot" style="background:var(--green)"></div>`;
    if(cnt===0)for(let i=0;i<3;i++)dots+=`<div class="hour-dot" style="background:var(--w10)"></div>`;
    tl.innerHTML+=`<div class="hour-row" style="${isA?"background:rgba(0,221,119,0.03);border-radius:8px;padding:10px;margin:0 -10px":""}"><div class="hour-label ${isA?"hl-active":""}">${c}</div><div class="hour-dots">${dots}</div><div style="font-family:'Bebas Neue',sans-serif;font-size:16px;min-width:30px;text-align:right;color:${cnt>0?"var(--green)":"var(--w20)"}">${cnt}</div></div>`;
  });
}

async function saveAllCortes(dk){
  const av=load("ec-cdmx-avance");if(!av[dk])return;
  const tr=load("ec-cdmx-tracker");
  let count=0;
  ALL.forEach(m=>{
    if(!av[dk][m.name])return;
    const inp=document.getElementById("avi-"+m.name.replace(/[^a-zA-Z]/g,""));
    if(!inp)return;
    const raw=inp.value.trim();
    if(raw==="")return; // Skip empty ‚Äî don't overwrite with 0
    const val=parseInt(raw.replace(/\D/g,""))||0;
    if(!av[dk][m.name].cortes)av[dk][m.name].cortes={};
    av[dk][m.name].cortes[selCorte]=val;
    // Auto-check tracker: last acumulado >= committed
    let lastAcum=0;
    CORTES.forEach(c=>{if(av[dk][m.name].cortes[c]!==undefined&&av[dk][m.name].cortes[c]!==null)lastAcum=av[dk][m.name].cortes[c]});
    if(tr[dk]?.[m.name]){tr[dk][m.name].met=lastAcum>=tr[dk][m.name].committed}
    count++;
  });
  if(count===0){showToast("‚ö†Ô∏è No hay datos que guardar");return}
  await save("ec-cdmx-avance",av);
  await save("ec-cdmx-tracker",tr);
  renderAvance();
  showToast(`‚úÖ Corte ${selCorte} guardado y sincronizado ‚Äî ${count} registros`);
}

function updClock(){const n=new Date(),el=document.getElementById("live-clock");if(el)el.textContent=String(n.getHours()).padStart(2,"0")+":"+String(n.getMinutes()).padStart(2,"0")}
setInterval(updClock,30000);

// ‚ïê‚ïê‚ïê SHARE AVANCE (compact poster) ‚ïê‚ïê‚ïê
function shareAvance(){
  const now=new Date(),dk=toKey(now),av=load("ec-cdmx-avance"),dd=av[dk]||{};
  const poster=document.getElementById("avance-poster");

  // Calc totals ‚Äî acumulado: last corte = total done
  let tCom=0,tDone=0;
  const coordSet=new Set(TEAM.coordinadores);
  function _getDone(md){if(!md||!md.cortes)return 0;let mx=0;CORTES.forEach(c=>{const v=md.cortes[c];if(v!=null&&v>mx)mx=v});return mx}
  function _getNew(md,corte){if(!md||!md.cortes||!md.cortes[corte])return 0;const idx=CORTES.indexOf(corte);let p=0;for(let i=idx-1;i>=0;i--){if(md.cortes[CORTES[i]]!=null){p=md.cortes[CORTES[i]];break}}return Math.max(0,md.cortes[corte]-p)}
  ALL.forEach(m=>{const d=dd[m.name];if(d&&!coordSet.has(m.name)){tCom+=d.committed||0;tDone+=_getDone(d)}});
  const remaining=Math.max(0,tCom-tDone);
  const globalPct=tCom>0?Math.min(100,Math.round(tDone/tCom*100)):0;
  const barClr=globalPct>=80?"#00DD77":globalPct>=50?"#FFB800":"#FF4D00";
  const proj=calcProjection(dd,tDone);
  const projClr=proj!==null?(proj>=tCom?"#00DD77":proj>=tCom*0.7?"#FFB800":"#FF4D00"):"#333";

  // Header
  let h=`<div class="avp-badge"><span>${fmtDate(now)} ¬∑ CORTE ${selCorte||""}</span></div>`;
  h+=`<div class="avp-title">AVANCE DEL D√çA</div>`;
  h+=`<div class="avp-sub">ExpertCell CDMX ¬∑ <b>${globalPct}% completado</b></div>`;

  // Summary cards
  h+=`<div class="avp-summary" style="grid-template-columns:repeat(4,1fr)">
    <div class="avp-scard"><div class="avp-sl">META</div><div class="avp-sn" style="color:#FF4D00">${tCom}</div></div>
    <div class="avp-scard"><div class="avp-sl">HECHAS</div><div class="avp-sn" style="color:#00DD77">${tDone}</div></div>
    <div class="avp-scard"><div class="avp-sl">FALTAN</div><div class="avp-sn" style="color:#FFB800">${remaining}</div></div>
    <div class="avp-scard"><div class="avp-sl">PROYECCI√ìN</div><div class="avp-sn" style="color:${projClr}">${proj!==null?proj:"-"}</div></div>
  </div>`;

  // Progress bar
  h+=`<div class="avp-bar-wrap"><div class="avp-bar-fill" style="width:${globalPct}%;background:linear-gradient(90deg,${barClr},#FFB800)"></div></div>`;

  // Per member rows
  ["supervisores","coordinadores","capacitadores"].forEach(g=>{
    const active=TEAM[g].filter(n=>dd[n]);if(!active.length)return;
    const gm=GM[g];
    const clrMap={supervisores:"#FF4D00",coordinadores:"#FFB800",capacitadores:"#00AAFF"};
    const clr=clrMap[g];
    h+=`<div style="display:flex;align-items:center;gap:6px;margin:10px 0 6px">
      <div style="width:20px;height:20px;border-radius:5px;background:${clr};display:flex;align-items:center;justify-content:center;font-size:10px">${gm.icon}</div>
      <span style="font-family:'Bebas Neue',sans-serif;font-size:13px;letter-spacing:2px;color:#808080">${g.toUpperCase()}</span>
    </div>`;

    active.forEach(name=>{
      const md=dd[name],com=md.committed||0;
      const done=_getDone(md);
      const left=Math.max(0,com-done);
      const pct=com>0?Math.min(100,Math.round(done/com*100)):0;
      const sc=pct>=100?"#00DD77":pct>=50?"#FFB800":"#FF4D00";

      h+=`<div class="avp-row">
        <div class="avp-rname" style="color:${clr}">${name}</div>
        <div class="avp-rbar"><div class="avp-rbar-fill" style="width:${pct}%;background:${pct>=100?"#00DD77":clr}"></div></div>
        <div class="avp-rnums"><b>${done}</b>/${com}</div>
        <div class="avp-rpct" style="color:${sc}">${pct}%</div>
      </div>`;
    });
  });

  // Cortes summary row
  h+=`<div style="display:flex;gap:4px;margin-top:14px;justify-content:center;flex-wrap:wrap">`;
  CORTES.forEach(c=>{
    let cnt=0;ALL.forEach(m=>{const d=dd[m.name];if(d&&!coordSet.has(m.name))cnt+=_getNew(d,c)});
    const isActive=c===selCorte;
    h+=`<div style="text-align:center;padding:4px 8px;border-radius:8px;font-size:8px;letter-spacing:.5px;
      ${isActive?"background:#00DD77;color:#0A0A12;font-weight:800":"background:#15151F;color:#4D4D4D;border:1px solid #252535"}">
      ${c}<br><span style="font-family:'Bebas Neue',sans-serif;font-size:14px">${cnt}</span>
    </div>`;
  });
  h+=`</div>`;

  h+=`<div class="avp-footer">EXPERTCELL CDMX ‚Äî AVANCE AT&T ¬∑ PALABRA DE CAMPEONES</div>`;

  poster.innerHTML=h;

  // Move to visible position temporarily for capture
  poster.style.position="fixed";poster.style.left="0";poster.style.top="0";poster.style.zIndex="-1";poster.style.opacity="1";
  showToast("üì∏ Generando imagen...");

  setTimeout(()=>{
    html2canvas(poster,{backgroundColor:"#0A0A12",scale:3,useCORS:true,logging:false,width:420}).then(canvas=>{
      poster.style.position="absolute";poster.style.left="-9999px";poster.style.zIndex="";
      canvas.toBlob(blob=>{
        const fname=`ExpertCell_Avance_${now.getDate()}-${now.getMonth()+1}_${(selCorte||"").replace(":","")}.png`;
        if(navigator.share&&navigator.canShare){
          const file=new File([blob],fname,{type:"image/png"});
          if(navigator.canShare({files:[file]})){navigator.share({files:[file],title:"ExpertCell Avance"}).catch(()=>downloadBlob(blob,fname));return}
        }
        downloadBlob(blob,fname);
      },"image/png");
    }).catch(()=>{
      poster.style.position="absolute";poster.style.left="-9999px";
      showToast("‚ùå Error al generar imagen");
    });
  },100);
}

// ‚ïê‚ïê‚ïê SCREENSHOT ‚ïê‚ïê‚ïê
function screenshot(elementId, label){
  const el=document.getElementById(elementId);
  if(!el)return;
  showToast("üì∏ Generando imagen...");
  // Temporarily add padding/bg for nice capture
  const origBg=el.style.background;const origPad=el.style.padding;const origRad=el.style.borderRadius;
  el.style.background="var(--dark)";el.style.padding="20px";el.style.borderRadius="0";
  html2canvas(el,{backgroundColor:"#0A0A12",scale:2,useCORS:true,logging:false}).then(canvas=>{
    el.style.background=origBg;el.style.padding=origPad;el.style.borderRadius=origRad;
    // Try native share first (mobile)
    canvas.toBlob(blob=>{
      const now=new Date();
      const fname=`ExpertCell_${label}_${now.getDate()}-${now.getMonth()+1}-${now.getFullYear()}.png`;
      if(navigator.share&&navigator.canShare){
        const file=new File([blob],fname,{type:"image/png"});
        if(navigator.canShare({files:[file]})){
          navigator.share({files:[file],title:`ExpertCell ${label}`}).then(()=>{
            showToast("‚úÖ Compartido");
          }).catch(()=>{downloadBlob(blob,fname)});
          return;
        }
      }
      downloadBlob(blob,fname);
    },"image/png");
  }).catch(()=>{
    el.style.background=origBg;el.style.padding=origPad;el.style.borderRadius=origRad;
    showToast("‚ùå Error al generar imagen");
  });
}
function downloadBlob(blob,fname){
  const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=fname;
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  showToast("‚úÖ Imagen descargada ‚Äî comparte por WhatsApp");
}

// ‚ïê‚ïê‚ïê TAB 3: TRACKER ‚ïê‚ïê‚ïê
function navWeek(d){weekStart=new Date(weekStart);weekStart.setDate(weekStart.getDate()+d*7);renderTracker()}
function renderTracker(){
  const days=weekDays(weekStart),tk=toKey(new Date()),tr=load("ec-cdmx-tracker");
  document.getElementById("week-range").textContent=`${days[0].getDate()}/${days[0].getMonth()+1} ‚Äî ${days[5].getDate()}/${days[5].getMonth()+1}`;
  let wT=0,wM=0;days.forEach(d=>{const dk=toKey(d);if(tr[dk])Object.values(tr[dk]).forEach(e=>{if(e.committed>0){wT++;if(e.met)wM++}})});
  const wP=wT>0?Math.round(wM/wT*100):0;
  document.getElementById("wk-total").textContent=wT;document.getElementById("wk-met").textContent=wM;
  const pe=document.getElementById("wk-pct");pe.textContent=wP+"%";pe.style.color=pctClr(wP);
  const tb=document.getElementById("tracker-table");
  let h=`<thead><tr><th>MIEMBRO</th>`;
  days.forEach(d=>{const dk=toKey(d);h+=`<th class="${dk===tk?"today":""}">${DS[d.getDay()]}<br>${d.getDate()}</th>`});
  h+=`<th style="color:var(--gold)">%</th></tr></thead><tbody>`;
  ["supervisores","coordinadores","capacitadores"].forEach(g=>{
    const gm=GM[g],ic=g==="supervisores"?"icon-sup":g==="coordinadores"?"icon-coord":"icon-cap";
    h+=`<tr class="group-row"><td colspan="${days.length+2}"><span class="section-icon ${ic}" style="width:20px;height:20px;border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-size:10px;vertical-align:middle;margin-right:6px">${gm.icon}</span><span style="color:var(--w50);font-weight:800;font-size:11px;letter-spacing:2px;vertical-align:middle">${g.toUpperCase()}</span></td></tr>`;
    TEAM[g].forEach(name=>{
      let tD=0,mD=0;Object.values(tr).forEach(dy=>{if(dy[name]?.committed>0){tD++;if(dy[name].met)mD++}});const p=tD>0?Math.round(mD/tD*100):0;
      h+=`<tr class="member-row"><td>${name}</td>`;
      days.forEach(d=>{const dk=toKey(d),isT=dk===tk,e=tr[dk]?.[name],hc=e&&e.committed>0,mt=e?.met||false;
        h+=`<td class="${isT?"today-col":""}">`;
        if(hc)h+=`<div class="commit-val">${e.committed}v</div><button class="check-btn ${mt?"checked":""}" onclick="togChk('${name}','${dk}')">${mt?"‚úì":""}</button>`;
        else h+=`<input class="mini-input" type="text" inputmode="numeric" placeholder="‚Äì" onchange="setTC('${name}','${dk}',this.value)">`;
        h+=`</td>`});
      h+=`<td class="pct-cell"><div class="pct-num" style="color:${p>0?pctClr(p):"var(--w20)"}">${p}%</div><div class="pct-detail">${mD}/${tD}</div></td></tr>`;
    });
  });
  h+=`</tbody>`;tb.innerHTML=h;
}
function togChk(n,dk){const t=load("ec-cdmx-tracker");if(!t[dk])t[dk]={};if(!t[dk][n])t[dk][n]={committed:0,met:false};t[dk][n].met=!t[dk][n].met;save("ec-cdmx-tracker",t);renderTracker()}
function setTC(n,dk,v){const num=parseInt(v.replace(/\D/g,""))||0;if(!num)return;const t=load("ec-cdmx-tracker");if(!t[dk])t[dk]={};t[dk][n]={committed:num,met:false};save("ec-cdmx-tracker",t);renderTracker()}

// ‚ïê‚ïê‚ïê SHARE TRACKER (compact poster) ‚ïê‚ïê‚ïê
function shareTracker(){
  const days=weekDays(weekStart),tr=load("ec-cdmx-tracker"),poster=document.getElementById("tracker-poster");
  let wT=0,wM=0;
  days.forEach(d=>{const dk=toKey(d);if(tr[dk])Object.values(tr[dk]).forEach(e=>{if(e.committed>0){wT++;if(e.met)wM++}})});
  const wP=wT>0?Math.round(wM/wT*100):0;
  const barClr=wP>=80?"#00DD77":wP>=50?"#FFB800":"#FF4D00";

  let h=`<div class="avp-badge"><span>SEMANA ${days[0].getDate()}/${days[0].getMonth()+1} ‚Äî ${days[5].getDate()}/${days[5].getMonth()+1}</span></div>`;
  h+=`<div class="avp-title">TRACKER DE CUMPLIMIENTO</div>`;
  h+=`<div class="avp-sub">ExpertCell CDMX ¬∑ <b>${wP}% cumplimiento semanal</b></div>`;
  h+=`<div class="avp-summary">
    <div class="avp-scard"><div class="avp-sl">COMPROMISOS</div><div class="avp-sn" style="color:#FF4D00">${wT}</div></div>
    <div class="avp-scard"><div class="avp-sl">CUMPLIDOS</div><div class="avp-sn" style="color:#00DD77">${wM}</div></div>
    <div class="avp-scard"><div class="avp-sl">% SEMANAL</div><div class="avp-sn" style="color:${barClr}">${wP}%</div></div>
  </div>`;
  h+=`<div class="avp-bar-wrap"><div class="avp-bar-fill" style="width:${wP}%;background:linear-gradient(90deg,${barClr},#FFB800)"></div></div>`;

  // Day headers
  h+=`<div style="display:flex;gap:2px;margin-bottom:6px;padding:0 70px 0 76px">`;
  days.forEach(d=>{h+=`<div style="flex:1;text-align:center;font-size:8px;color:#4D4D4D;font-weight:700">${DS[d.getDay()]}<br>${d.getDate()}</div>`});
  h+=`<div style="width:32px;text-align:center;font-size:8px;color:#FFB800;font-weight:700">%</div></div>`;

  // Per member
  ["supervisores","coordinadores","capacitadores"].forEach(g=>{
    const gm=GM[g];const clrMap={supervisores:"#FF4D00",coordinadores:"#FFB800",capacitadores:"#00AAFF"};const clr=clrMap[g];
    h+=`<div style="display:flex;align-items:center;gap:6px;margin:8px 0 4px">
      <div style="width:18px;height:18px;border-radius:4px;background:${clr};display:flex;align-items:center;justify-content:center;font-size:9px">${gm.icon}</div>
      <span style="font-family:'Bebas Neue',sans-serif;font-size:12px;letter-spacing:2px;color:#808080">${g.toUpperCase()}</span>
    </div>`;

    TEAM[g].forEach(name=>{
      let tD=0,mD=0;Object.values(tr).forEach(dy=>{if(dy[name]?.committed>0){tD++;if(dy[name].met)mD++}});
      const p=tD>0?Math.round(mD/tD*100):0;
      const pc=p>=80?"#00DD77":p>=50?"#FFB800":p>0?"#FF4D00":"#333";

      h+=`<div style="display:flex;align-items:center;gap:4px;padding:5px 0;border-bottom:1px solid #12121C">
        <div style="font-size:11px;font-weight:600;color:#bbb;min-width:70px">${name}</div>`;

      days.forEach(d=>{
        const dk=toKey(d),e=tr[dk]?.[name],hasCom=e&&e.committed>0,met=e?.met||false;
        if(hasCom){
          h+=`<div style="flex:1;text-align:center;font-size:10px">
            <div style="width:20px;height:20px;border-radius:5px;margin:0 auto;display:flex;align-items:center;justify-content:center;
              ${met?"background:rgba(0,221,119,0.15);border:1.5px solid #00DD77;color:#00DD77;font-size:11px":"background:rgba(255,255,255,0.02);border:1.5px solid #333;color:#333"}">${met?"‚úì":""}</div>
          </div>`;
        } else {
          h+=`<div style="flex:1;text-align:center"><div style="width:20px;height:20px;margin:0 auto;display:flex;align-items:center;justify-content:center;color:#1A1A28;font-size:8px">‚Äî</div></div>`;
        }
      });

      h+=`<div style="font-family:'Bebas Neue',sans-serif;font-size:14px;width:32px;text-align:center;color:${pc}">${p}%</div></div>`;
    });
  });

  h+=`<div class="avp-footer">EXPERTCELL CDMX ‚Äî TRACKER AT&T ¬∑ PALABRA DE CAMPEONES</div>`;
  poster.innerHTML=h;

  poster.style.position="fixed";poster.style.left="0";poster.style.top="0";poster.style.zIndex="-1";poster.style.opacity="1";
  showToast("üì∏ Generando imagen...");
  setTimeout(()=>{
    html2canvas(poster,{backgroundColor:"#0A0A12",scale:3,useCORS:true,logging:false,width:420}).then(canvas=>{
      poster.style.position="absolute";poster.style.left="-9999px";
      canvas.toBlob(blob=>{
        const fname=`ExpertCell_Tracker_Sem${days[0].getDate()}-${days[0].getMonth()+1}.png`;
        if(navigator.share&&navigator.canShare){const file=new File([blob],fname,{type:"image/png"});if(navigator.canShare({files:[file]})){navigator.share({files:[file]}).catch(()=>downloadBlob(blob,fname));return}}
        downloadBlob(blob,fname);
      },"image/png");
    }).catch(()=>{poster.style.position="absolute";poster.style.left="-9999px";showToast("‚ùå Error")});
  },100);
}

buildInputs();updClock();syncAll();
</script>
</body>
</html>
